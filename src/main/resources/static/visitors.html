<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Customer Ratings Analysis</title>
    <script src="https://cdn.canvasjs.com/canvasjs.min.js"></script>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <header>
        <h1>Visitor Demographic Analysis</h1>
    </header>
    <div class="filters-container">
        <form id="filterForm">
            <div class="filter-block">
                <h2>Time Frame</h2>
                <label for="yearStart">Start Year:</label>
                <input type="number" id="yearStart" name="yearStart" min="2000" max="2099">
                <label for="yearEnd">End Year:</label>
                <input type="number" id="yearEnd" name="yearEnd" min="2000" max="2099">
            </div>
            <button type="button" onclick="updateChart()">Generate</button>
        </form>
    </div>

   <!-- First Chart Container -->
   <div id="chartContainer1"></div>
   <div id="chartContainer2"></div>

   <script>
    function updateChart() {
        const yearStart = document.getElementById('yearStart').value;
        const yearEnd = document.getElementById('yearEnd').value;
        const urlParams = new URLSearchParams(window.location.search);
        const districtNr = urlParams.get('user');

        fetch(`/portal_service/api/analytics/visitor-demographics?` + new URLSearchParams({
            yearStart: yearStart,
            yearEnd: yearEnd,
            districtNr: districtNr
        }))
        .then(response => response.json())
        .then(data => {
            displayData(data);
            renderGenderChart(data);
            renderAgeChart(data);
        })
        .catch(error => {
            console.error('Error fetching visitor reviews:', error);
            document.getElementById('demographicList').innerHTML = `<li>Error loading data: ${error.message}</li>`;
        });
    }

    function displayData(data) {
            const list = document.getElementById('demographicList');
            list.innerHTML = '';
            data.forEach(datapoint => {
                const item = document.createElement('li');
                item.textContent = `Gender: ${datapoint.gender}, Age: ${datapoint.age}`;
                list.appendChild(item);
            });
        }

    function renderGenderChart(data) {
    const genderCounts = {
        "Male": 0,
        "Female": 0,
        "Diverse": 0
    };

    data.forEach(datapoint => {
        if (datapoint.gender) {
            if (datapoint.gender.toLowerCase() === "male") {
                genderCounts["Male"]++;
            } else if (datapoint.gender.toLowerCase() === "female") {
                genderCounts["Female"]++;
            } else {
                genderCounts["Diverse"]++;
            }
        }
    });

    // Calculate total counts to determine percentages
    const totalCount = genderCounts["Male"] + genderCounts["Female"] + genderCounts["Diverse"];

    // Map counts to percentages
    const dataPoints = [
        { y: (genderCounts["Male"] / totalCount * 100), label: "Male" },
        { y: (genderCounts["Female"] / totalCount * 100), label: "Female" },
        { y: (genderCounts["Diverse"] / totalCount * 100), label: "Diverse" }
    ];

    console.log('Gender Data Points:', dataPoints); // Debugging output

    const chart = new CanvasJS.Chart("chartContainer1", {
        animationEnabled: true,
        title: {
            text: "Gender Distribution"
        },
        data: [{
            type: "pie",
            startAngle: 240,
            yValueFormatString: "##0.00\"%\"", // Ensure the format includes only two decimal places followed by '%'
            indexLabel: "{label}: {y}%", // Display label and percentage on the chart
            dataPoints: dataPoints
        }]
    });
    chart.render();
}

function renderAgeChart(data) {
    const genderCounts = {
        "Children": 0,
        "Young Adults": 0,
        "Adults": 0,
        "Older Adults": 0,
        "Seniors": 0
    };

    data.forEach(datapoint => {
        if (datapoint.age) {
            if (datapoint.age < 18) {
                genderCounts["Children"]++;
            } else if (datapoint.age < 35) {
                genderCounts["Young Adults"]++;
            } else if (datapoint.age < 52) {
                genderCounts["Adults"]++;
            } else if (datapoint.age < 69) {
                genderCounts["Older Adults"]++;
            } else {
                genderCounts["Seniors"]++;
            }
        }
    });

    // Calculate total counts to determine percentages
    const totalCount = genderCounts["Children"] + genderCounts["Young Adults"] + genderCounts["Adults"] + genderCounts["Older Adults"] + genderCounts["Seniors"];

    // Map counts to percentages
    const dataPoints = [
        { y: (genderCounts["Children"] / totalCount * 100), label: "Children" },
        { y: (genderCounts["Young Adults"] / totalCount * 100), label: "Young Adults" },
        { y: (genderCounts["Adults"] / totalCount * 100), label: "Adults" },
        { y: (genderCounts["Older Adults"] / totalCount * 100), label: "Older Adults" },
        { y: (genderCounts["Seniors"] / totalCount * 100), label: "Seniors" }
    ];

    console.log('Age Data Points:', dataPoints); // Debugging output

    const chart = new CanvasJS.Chart("chartContainer2", {
        animationEnabled: true,
        title: {
            text: "Age Distribution"
        },
        data: [{
            type: "pie",
            startAngle: 240,
            yValueFormatString: "##0.00\"%\"", // Ensure the format includes only two decimal places followed by '%'
            indexLabel: "{label}: {y}%", // Display label and percentage on the chart
            dataPoints: dataPoints
        }]
    });
    chart.render();
}

    </script>
    <div id="dataDisplay" style="margin-top: 10px;">
        <h2>Review Data details:</h2>
         <ul id="demographicList"></ul>
     </div>
</body>
</html>
